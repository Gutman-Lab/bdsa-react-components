# bdsa-react-components v0.1.19 - Update Notes

**Date:** November 10, 2025  
**Previous Version:** v0.1.18  
**New Version:** v0.1.19

## üéØ Overview

This release focuses on major UX improvements to the `FolderBrowser` component, including smart item management, visual feedback enhancements, AI model detection, and scroll stability improvements.

---

## üöÄ New Features

### 1. **FolderBrowser: Item Count Display** üìä

Folders now display the total number of items they contain next to their name.

**Props Added:**
- `showItemCount?: boolean` - Enable/disable item count display (default: `false`)

**Visual Display:**
```
‚ñ∂ myFolder (150)... Folder
```
- `(150)` = Total item count
- `...` = Indicator that more items can be loaded (appears after the count)
- Double-click `...` to automatically load ALL remaining items in the background

**Example Usage:**
```tsx
<FolderBrowser
  apiBaseUrl="https://api.example.com"
  showCollections={true}
  showItems={true}
  showItemCount={true}  // ‚Üê New prop
  apiHeaders={{ 'Girder-Token': token }}
/>
```

**Features:**
- Automatically displays total count from API
- Shows `...` indicator when there are more items to paginate
- `...` is clickable (double-click) to load all remaining items at once
- Shows ‚è≥ (hourglass) animation while loading all items
- Item count appears immediately after folder name (left-justified)

---

### 2. **FolderBrowser: AI Model Detection** ü§ñ

Items are now automatically classified and displayed with appropriate icons based on their metadata.

**New Utility Functions:**
```typescript
import { isAIModel, filterAIModels } from 'bdsa-react-components'

// Check if an item is an AI model
const isModel = isAIModel(item)  // Returns true if item.meta has dataset_args AND train_args

// Filter array to only AI models
const models = filterAIModels(items)
```

**Item Type Classification:**
1. **ü§ñ AI Model** - Items with `meta.dataset_args` AND `meta.train_args`
2. **üñºÔ∏è Image** - Items with `largeImage` flag (whole slide images)
3. **üìÑ Item** - Regular items

**Visual Display in FolderBrowser:**
```
ü§ñ my_trained_model.pth        AI Model
üñºÔ∏è slide_image_001.svs         Image
üìÑ data.csv                    Item
```

**Detection Logic:**
An item is classified as an AI Model if it has BOTH:
- `item.meta.dataset_args` (dataset configuration)
- `item.meta.train_args` (training configuration)

The `meta.results` field is optional and not required for detection.

---

### 3. **FolderBrowser: Improved Scroll Stability** üéØ

Fixed the jarring scroll jumps when expanding/collapsing folders.

**What Changed:**
- The clicked folder now stays in the exact same screen position when you expand/collapse it
- No more losing track of which folder you just clicked
- Works by capturing the folder's position before DOM changes and adjusting scroll to compensate

**Visual Feedback:**
- **Last-clicked folder** gets a prominent dark blue highlight
- Helps you track which folder you're currently working with
- Persists until you click a different folder

**CSS Classes:**
- `.last-clicked` - Applied to the most recently clicked folder
  - Darker blue background (#bbdefb)
  - Thicker 3px left border (#1976d2)

---

### 4. **FolderBrowser: Smart Item Fetching** üîç

Better control over when and how items are fetched.

**Existing Props (reminder):**
```typescript
{
  fetchItems?: boolean        // Controls if items are fetched (independent of showItems)
  showItems?: boolean         // Controls if items are displayed in tree
  itemFilter?: (item) => boolean  // Filter items before display
  onItemsFetched?: (folderId: string, items: Item[]) => void  // Callback with ALL items
  showItemCount?: boolean     // Show item counts next to folders
}
```

**Common Patterns:**

**Pattern 1: Fetch but don't display (for counting/processing)**
```tsx
<FolderBrowser
  fetchItems={true}      // Fetch items
  showItems={false}      // Don't display in tree
  showItemCount={true}   // Show counts
  onItemsFetched={(folderId, items) => {
    console.log(`Folder ${folderId} has ${items.length} items`)
    // Process items here (e.g., count, filter, analyze)
  }}
/>
```

**Pattern 2: Fetch and display with filtering**
```tsx
<FolderBrowser
  fetchItems={true}
  showItems={true}
  itemFilter={(item) => hasLargeImage(item)}  // Only show images
  showItemCount={true}  // Count shows ALL items, not just filtered
  onItemsFetched={(folderId, items) => {
    // Called with ALL items before filtering
  }}
/>
```

**Pattern 3: Don't fetch items at all**
```tsx
<FolderBrowser
  showItems={false}  // fetchItems defaults to false
  // Items won't be fetched, no counts will show
/>
```

---

### 5. **FolderBrowser: Authentication Integration** üîê

Fixed authentication state detection in Storybook examples.

**IMPORTANT - Breaking Change:**

The `useDsaAuth()` hook returns an object structure, not flat properties.

**‚ùå Old (Incorrect) Usage:**
```tsx
const { isAuthenticated, token, userInfo } = useDsaAuth()  // WRONG!
```

**‚úÖ New (Correct) Usage:**
```tsx
const { authStatus, getToken } = useDsaAuth()
const token = getToken()
const isAuthenticated = authStatus.isAuthenticated
const userInfo = authStatus.user
```

**Complete Auth + FolderBrowser Example:**
```tsx
import { DsaAuthManager, FolderBrowser, useDsaAuth } from 'bdsa-react-components'

function MyComponent() {
  const { authStatus, getToken } = useDsaAuth()
  const token = getToken()
  const isAuthenticated = authStatus.isAuthenticated

  return (
    <>
      <DsaAuthManager apiBaseUrl="https://api.example.com" />
      
      <FolderBrowser
        key={isAuthenticated ? 'authenticated' : 'public'}  // Force re-mount on auth change
        apiBaseUrl="https://api.example.com"
        showCollections={true}
        showItems={true}
        showItemCount={true}
        apiHeaders={isAuthenticated && token ? {
          'Girder-Token': token
        } : undefined}
      />
    </>
  )
}
```

**Key Points:**
- Use `key` prop to force re-mount when auth state changes
- Pass `apiHeaders` conditionally based on auth state
- Public resources work without authentication
- Private resources require valid token

---

### 6. **SlideViewer: Annotation Opacity Optimization** ‚ö°

Improved performance when changing annotation opacity.

**What Changed:**
- Changing `annotationOpacity` or `annotationOpacities` props no longer triggers a full re-render
- Opacity updates now use a dedicated effect that only updates Paper.js layer opacity
- Significantly faster when adjusting opacity sliders in real-time

**Technical Details:**
- Removed `annotationOpacity` and `annotationOpacities` from main rendering effect dependencies
- Dedicated opacity update effect (lines 1614-1734) handles opacity changes efficiently
- No breaking changes - props work exactly the same, just faster

---

## üîß API Changes

### New Props

**FolderBrowser:**
- `showItemCount?: boolean` - Display item counts next to folders

### New Exports

```typescript
// Item utility functions
export { isAIModel, filterAIModels } from 'bdsa-react-components'
```

### Updated Type Definitions

**Item interface** now includes AI model metadata:
```typescript
interface Item {
  _id: string
  name?: string
  largeImage?: boolean | string | object
  meta?: {
    largeImage?: boolean | string | object
    dataset_args?: unknown    // ‚Üê New
    train_args?: unknown      // ‚Üê New
    results?: unknown         // ‚Üê New
    [key: string]: unknown
  }
  [key: string]: unknown
}
```

---

## üì¶ Installation & Update

### Update Package

```bash
npm install bdsa-react-components@0.1.19
# or
yarn add bdsa-react-components@0.1.19
```

### No Breaking Changes

All existing code should continue to work. The auth hook usage pattern should be updated if you're using it incorrectly (see section 5 above).

---

## üé® CSS Changes

### New Classes

- `.bdsa-folder-browser__item-count` - Item count display
- `.bdsa-folder-browser__load-all-indicator` - Clickable "..." indicator
- `.bdsa-folder-browser__load-all-indicator.loading` - Loading state with pulse animation
- `.bdsa-folder-browser__folder-header.last-clicked` - Visual feedback for last clicked folder

### Modified Classes

- `.bdsa-folder-browser__folder-name` - Changed from `flex: 1` to `flex: 0 1 auto` with `max-width: 60%`
- `.bdsa-folder-browser__folder-type` - Changed `margin-left: 4px` to `margin-left: auto` (pushed to right)

---

## üìù Migration Guide

### If you're using `showItems={true}` in FolderBrowser

**No changes needed!** Everything works as before, but you can now add:
```tsx
showItemCount={true}
```
to see item counts.

### If you're using `useDsaAuth()` incorrectly

**Update your code:**
```tsx
// Before:
const { isAuthenticated, token, userInfo } = useDsaAuth()

// After:
const { authStatus, getToken } = useDsaAuth()
const token = getToken()
const isAuthenticated = authStatus.isAuthenticated
const userInfo = authStatus.user
```

### If you want to detect AI models in your items

**Add filtering:**
```tsx
import { isAIModel, filterAIModels } from 'bdsa-react-components'

// Check individual item
if (isAIModel(item)) {
  console.log('This is an AI model!')
}

// Filter array
const modelItems = filterAIModels(allItems)
```

---

## üêõ Bug Fixes

1. **FolderBrowser scroll jumping** - Fixed annoying scroll behavior when expanding/collapsing folders
2. **Auth state not updating** - Fixed Storybook examples to properly react to login/logout
3. **Item count not displaying** - Fixed API response parsing for array vs. paginated responses
4. **Opacity changes causing re-renders** - Optimized SlideViewer annotation opacity updates

---

## üîç Testing Recommendations

### Test These Scenarios in Your App

1. **Login/Logout Flow**
   - Verify FolderBrowser refreshes when you log in/out
   - Check that public resources load without auth
   - Check that private resources load with auth token

2. **Item Counts**
   - Expand folders with many items
   - Verify counts appear correctly
   - Try double-clicking "..." to load all items

3. **AI Model Detection**
   - Browse folders containing AI models
   - Verify ü§ñ icon appears for models with dataset_args & train_args
   - Verify üñºÔ∏è icon appears for slide images
   - Verify üìÑ icon appears for regular items

4. **Scroll Stability**
   - Expand/collapse folders repeatedly
   - Verify the clicked folder stays in place
   - Verify blue highlight appears on last-clicked folder

5. **Annotation Opacity** (if using SlideViewer)
   - Adjust opacity sliders rapidly
   - Should be smooth without re-rendering entire viewer

---

## üí° Tips & Best Practices

### Item Count Usage

```tsx
// Good: Enable when you need counts
<FolderBrowser showItemCount={true} fetchItems={true} showItems={false} />

// Also Good: Show counts with items
<FolderBrowser showItemCount={true} showItems={true} />

// Not useful: Count without fetching
<FolderBrowser showItemCount={true} fetchItems={false} />  // Counts won't appear
```

### AI Model Filtering

```tsx
// Pre-filter to only show AI models
<FolderBrowser
  showItems={true}
  itemFilter={(item) => isAIModel(item)}
  showItemCount={true}  // Shows total, not just filtered
/>
```

### Performance with Large Folders

```tsx
// For large folders, fetch but don't display
<FolderBrowser
  fetchItems={true}      // Fetch for counting
  showItems={false}      // Don't render in tree (saves DOM nodes)
  showItemCount={true}   // Show counts
  itemsPerPage={50}      // Use pagination
  onItemsFetched={(folderId, items) => {
    // Process items in callback instead
    this.setState({ itemData: items })
  }}
/>
```

---

## üìö Related Documentation

- `CHANGELOG.md` - Full version history
- `DSA_AUTH_USAGE.md` - Authentication guide
- `CRITICAL_FEATURES.md` - Critical features overview
- `FolderBrowser` Storybook - Interactive examples

---

## üôã Questions or Issues?

If you encounter any issues with these changes:

1. Check the Storybook examples (especially "With Authentication" and "With Item Filtering")
2. Review the console logs for helpful debugging output
3. Verify your `useDsaAuth()` usage matches the new pattern
4. Check that `showItemCount` is enabled if you want counts

---

## üìä Summary of Changes

| Feature | Status | Breaking? |
|---------|--------|-----------|
| Item count display | ‚úÖ New | No |
| AI model detection | ‚úÖ New | No |
| Scroll stability | ‚úÖ Fixed | No |
| Auth integration | ‚úÖ Fixed | Yes* |
| Opacity optimization | ‚úÖ Improved | No |
| Load all items | ‚úÖ New | No |
| Visual feedback | ‚úÖ Enhanced | No |

*Auth hook usage pattern should be updated if using incorrectly

---

**Happy coding! üöÄ**



